# Урок 5. Форматы хранения

## Задачи

1. Развернуть [кластер](https://github.com/big-data-europe/docker-hive) через [Docker](https://www.docker.com/products/docker-desktop) (или выполнить ДЗ на учебном кластере, удалив файлы потом)
2. Загрузить в наш развернутый hdfs самый большой файл из [датасета](https://www.kaggle.com/fivethirtyeight/uber-pickups-in-new-york-city) и сделать external table (см. файл "hive.sql")
3. Далее создать таблицы с разными форматами как в local_hive.sql и попробовать пописать различные запросы, засечь и сравнить время.
4. Повторить эксперимент с паркетом и orc добавив 2 различных сжатия (GZIP/SNAPPY) и сравнить получившийся размер файлов с изначальным, а так же время выполнения запросов.

## Решение

Были получены выборки с помощью запросов:

```SQL
select count(*) from data; -- 1 запрос
select count(locationID) from data; -- 2 запрос
select count(distinct Dispatching_base_num) from data; -- 3 запрос
```

Проверялась скорость выполнения этих запросов в зависимости от формата хранения данных. Для проверки каждый запрос делался три раза. И при каджом повторении записывалось время его выполнения (в секундах). Для анализа использовалось только последние полученные значения, при получении которых все метаданные и "кеш" уже созданы (все результаты и SQL запросы для их получения смотреть в файле "results.sql"). Результаты отсортированы в порядке возрастания времени выполнения:

Формат хранения | **запрос 1**
--- | ---
PARQUET SNAPPY | 0.065
TEXTFILE | 0.068
PARQUET UNCOMPRESSED | 0.073
AVRO | 0.073
PARQUET GZIP | 0.083
ORC UNCOMPRESSED | 0.085
ORC ZLIB | 0.097
SequenceFile | 0.098

Формат хранения | **запрос 2**
--- | ---
ORC UNCOMPRESSED | 4.255
PARQUET UNCOMPRESSED | 4.259
PARQUET GZIP | 4.267
PARQUET SNAPPY | 4.288
ORC ZLIB | 4.302
TEXTFILE | 6.434
SequenceFile | 22.5
AVRO | 28.271

Формат хранения | **запрос 3**
--- | ---
PARQUET UNCOMPRESSED | 4.252
PARQUET GZIP | 4.254
ORC UNCOMPRESSED | 4.257
ORC ZLIB | 4.266
PARQUET SNAPPY | 4.27
TEXTFILE | 6.252
SequenceFile | 23.263
AVRO | 30.283

Для различных форматов хранения было проведено сравнение размеров файлов. Результаты отсортированы в порядке возрастания размера файла:

Формат хранения | **Размер МБ**
--- | ---
ORC ZLIB | 36.6
PARQUET GZIP | 50.6
ORC UNCOMPRESSED | 55.9
PARQUET SNAPPY | 66.8
PARQUET UNCOMPRESSED | 188.5
AVRO | 351.2
TEXTFILE | 512.5
SequenceFile | 682.5

Из результатов можно сделать вывод, что данные, сохранённые в формате "ORC ZLIB", занимают меньше всего места (~7 % от текстового формата без сжатия). При этом нельзя выделить абсолютного победителя и по размеру файлов и по скорости выполнения всех запросов. Во втором и третьем запросе лучше всего проявили себя форматы "PARQUET" и "ORC" с различными типами сжатия, а медленнее всех оказались "SequenceFile" и "AVRO".
